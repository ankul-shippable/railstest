language: ruby

env:
  global:
    - TESTPATH=test/
    - TESTREPORTSPATH=test/reports/
  matrix:
    - MATRIX_JOB=0
    - MATRIX_JOB=1
    - MATRIX_JOB=2
    - MATRIX_JOB=3

rvm:
  - 2.6

build:
  ci:
    - ruby -v
    - sudo apt-get install tree
    - pip install yq
    - gem install bundler
    - bundle install
    - git clone https://github.com/ankul-shippable/node.git
    - sudo node/shipctl/x86_64/Ubuntu_16.04/install.sh
    - |
        if [ ! -d \"/tmp/cache/$TESTREPORTSPATH\" ];
        then
          mkdir -p /tmp/cache/$TESTREPORTSPATH
        fi
    - tree /tmp/cache/$TESTREPORTSPATH
    # find test files to run in this job using shipctl split_tests
    - test_files=$(shipctl split_tests $TESTPATH \*_test.rb /tmp/cache/$TESTREPORTSPATH)
    # run tests
    - bundle exec ruby -I.:test -e "ARGV.each{|f| require f}" ${test_files[@]}
    # cache test reports
    - cp -ru $TESTREPORTSPATH/. /tmp/cache/$TESTREPORTSPATH/
     
    # print data to verify split_tests command
    - tree $TESTREPORTSPATH
    - tree /tmp/cache/$TESTREPORTSPATH
    - printf '%s\n' "${test_files[@]}"
    - cat /tmp/current_tests.txt
    - cat /tmp/cached_test_timings.txt
    - cat /tmp/sorted_cached_test_timings.txt
    - cat /tmp/sorted_cached_tests.txt

  cache: true
  cache_dir_list:
    - /tmp/cache
