language: ruby

env:
  global:
    - TESTPATH=test/
    - TESTREPORTSPATH=test/reports/
    - PARALLELIZATION=4
  matrix:
    - NODENUMBER=0
    - NODENUMBER=1
    - NODENUMBER=2
    - NODENUMBER=3

rvm:
  - 2.6

build:
  ci:
    - ruby -v
    - sudo apt-get install tree
    - tree $TESTREPORTSPATH
    - pip install yq
    - gem install bundler
    - bundle install
    - tree /tmp
    - |
        if [ -d /tmp/cache/$TESTREPORTSPATH ];
        then
          mkdir -p $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH
          cp -r /tmp/cache/$TESTREPORTSPATH/. $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH
        fi
    - tree $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH
    #this whole section will become a shipctl command. for now adding it to punchh-server until shippable ships this
    - |
        rm -rf /tmp/currentTests.txt
        for i in "$(find $TESTPATH -name \*_test.rb)"; do echo -e "$i\n" >> /tmp/currentTests.txt; done
        rm -rf /tmp/pastTestTimes.txt
        for i in "$(find $TESTREPORTSPATH -name \*.xml)"; do
          echo $(xq .testsuites.testsuite $i | jq -cr '.["@filepath"]," ", .["@time"]') >> /tmp/pastTestTimes.txt
        done
        sort -k 2n /tmp/pastTestTimes.txt > /tmp/sorted_pastTestTimes.txt
        awk -F" " '{print $1}' /tmp/sorted_pastTestTimes.txt > /tmp/sorted_pastTests.txt
        IFS=$'\r\n' GLOBIGNORE='*' command eval  'PastTests=($(cat /tmp/sorted_pastTests.txt))'
        IFS=$'\r\n' GLOBIGNORE='*' command eval  'CurrentTests=($(cat /tmp/currentTests.txt))'
        AllTests=()
        CurrentRunTests=()
        for i in "${PastTests[@]}"; do
          skip=
          for j in "${CurrentTests[@]}"; do
            [[ $i == $j ]] && { skip=1; break; }
          done
          [[ -n $skip ]] && AllTests+=($i)
        done
        for i in "${CurrentTests[@]}"; do
          skip=
          for j in "${PastTests[@]}"; do
            [[ $i == $j ]] && { skip=1; break; }
          done
          [[ -n $skip ]] || AllTests+=($i)
        done
        tLen=${#AllTests[@]}
        for (( i=${NODENUMBER}; i<${tLen}; i=i+${PARALLELIZATION} ));
        do
          CurrentRunTests+=(${AllTests[$i]})
        done
        echo "Number of tests in this pass is ${#CurrentRunTests[@]}"
    - printf '%s\n' "${CurrentRunTests[@]}"
    - |
        if [ -d \"$TESTREPORTSPATH\" ];
        then
          cp -r $TESTREPORTSPATH/. /tmp/reports\n  rm -rf $TESTREPORTSPATH
        fi
    - mkdir -p $TESTREPORTSPATH
    - bundle exec ruby -I.:test -e "ARGV.each{|f| require f}" ${CurrentRunTests[@]}
    - tree test/reports
    - cp -ru /tmp/reports/. $TESTREPORTSPATH
    - mkdir -p /tmp/cache/$TESTREPORTSPATH\ncp -r $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH/. /tmp/cache/$TESTREPORTSPATH/\n

  cache: true
  cache_dir_list:
    - /tmp/cache
