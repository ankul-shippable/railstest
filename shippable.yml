language: ruby

env:
  global:
    - TESTPATH=test/
    - TESTREPORTSPATH=test/reports/
  matrix:
    - JOB=0
    - JOB=1
    - JOB=2
    - JOB=3

rvm:
  - 2.6

build:
  ci:
    - ruby -v
    - sudo apt-get install tree
    - pip install yq
    - gem install bundler
    - bundle install
    - tree /tmp/cache/$TESTREPORTSPATH
    - |
        if [ -d /tmp/cache/$TESTREPORTSPATH ];
        then
          mkdir -p $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH
          cp -r /tmp/cache/$TESTREPORTSPATH/. $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH
        fi
    - tree $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH
    - sudo mkdir /tmp/reports
    - git clone https://github.com/ankul-shippable/node.git
    - sudo node/shipctl/x86_64/Ubuntu_16.04/install.sh
    - shipctl split_tests $TESTPATH "\*_test.rb" $TESTREPORTSPATH
    - sudo cat /tmp/pastTestTimes.txt || true
    - sudo cat /tmp/sorted_pastTestTimes.txt || true
    - sudo cat /tmp/sorted_pastTests.txt || true
    - printf '%s\n' "${AllTests[@]}"
    - printf '%s\n' "${PastTests[@]}"
    - printf '%s\n' "${CurrentRunTests[@]}"
    - |
        if [ -d \"$TESTREPORTSPATH\" ];
        then
          sudo mkdir /tmp/reports
          cp -r $TESTREPORTSPATH/. /tmp/reports
          rm -rf $TESTREPORTSPATH
        fi
    - mkdir -p $TESTREPORTSPATH
    - bundle exec ruby -I.:test -e "ARGV.each{|f| require f}" ${CurrentRunTests[@]}
    - tree test/reports
    - cp -ru /tmp/reports/. $TESTREPORTSPATH
    - mkdir -p /tmp/cache/$TESTREPORTSPATH
    - cp -r $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH/. /tmp/cache/$TESTREPORTSPATH/
    - tree /tmp/cache/$TESTREPORTSPATH

  cache: true
  cache_dir_list:
    - /tmp/cache
