language: ruby

env:
  global:
    - TESTPATH=test/
    - TESTREPORTSPATH=test/reports/
    - TESTSCACHEDPATH=tmp/cache/
    - PARALLELIZATION=4
  matrix:
    - NODENUMBER=0
    - NODENUMBER=1
    - NODENUMBER=2
    - NODENUMBER=3

rvm:
  - 2.6

build:
  ci:
    - ruby -v
    - sudo apt-get install tree
    - find $TESTREPORTSPATH -name \*.xml
    - gem install bundler
    - bundle install
    - rm -rf /tmp/currentTests.txt\nfor i in \"$(find $TESTPATH -name \\*_test.rb)\"; do echo -e \"$i\\n\" >> /tmp/currentTests.txt; done\nrm -rf /tmp/pastTestTimes.txt\nfor i in \"$(find $TESTSCACHEDPATH -name \\*.xml)\"; do\n  echo $(xq .testsuites.testsuite $i | jq -cr '.[\"@filepath\"],\" \", .[\"@time\"]') >> /tmp/pastTestTimes.txt\ndone\nsort -k 2n /tmp/pastTestTimes.txt > /tmp/sorted_pastTestTimes.txt\nawk -F\" \" '{print $1}' /tmp/sorted_pastTestTimes.txt >  /tmp/sorted_pastTests.txt\nIFS=$'\\r\\n' GLOBIGNORE='*' command eval  'PastTests=($(cat /tmp/sorted_pastTests.txt))'\nIFS=$'\\r\\n' GLOBIGNORE='*' command eval  'CurrentTests=($(cat /tmp/currentTests.txt))'\nAllTests=()\nCurrentRunTests=()\nfor i in \"${PastTests[@]}\"; do\n  skip=\n  for j in \"${CurrentTests[@]}\"; do\n    [[ $i == $j ]] && { skip=1; break; }\n  done\n  [[ -n $skip ]] && AllTests+=($i)\ndone\nfor i in \"${CurrentTests[@]}\"; do\n  skip=\n  for j in \"${PastTests[@]}\"; do\n    [[ $i == $j ]] && { skip=1; break; }\n  done\n  [[ -n $skip ]] || AllTests+=($i)\ndone\ntLen=${#AllTests[@]}\nfor (( i=${NODENUMBER}; i<${tLen}; i=i+${PARALLELIZATION} ));\ndo\n  CurrentRunTests+=(${AllTests[$i]})\ndone\necho \"Number of tests in this pass is ${#CurrentRunTests[@]}\"\n",
    - printf '%s\n' "${CurrentRunTests[@]}"
    - bundle exec ruby -I.:test -e "ARGV.each{|f| require f}" ${CurrentRunTests[@]}
    - tree test/
    - mkdir -p /tmp/cache/$TESTREPORTSPATH\ncp -r $SHIPPABLE_BUILD_DIR/$TESTREPORTSPATH/. /tmp/cache/$TESTREPORTSPATH/\n

  cache: true
  cache_dir_list:
    - /tmp/cache
